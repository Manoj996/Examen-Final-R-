---
title: "Examen Final"
author: "Manoj Jhangimal"
date: "28/11/2019"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    theme: sandstone
    highlight: tango
---
```{r, echo=FALSE,include=FALSE,warning=FALSE}
library(rvest)
library(lubridate)
library(reshape2)
library(ggplot2)
library(kableExtra)
library(knitr)
library(magrittr)
library(plotly)
```

## Funciones REGEX

Las expresiones regulares consisten en la manipulación de data tipo string o texto, que nos ayudan en convertir archivos de texto en datos que pueden ser útiles para su manipulación y análisis. Esto también incluye extraer ciertos formatos que puedan ser difíciles de leer o palabras que no estén bien escrita.  La manera en el que las expresiones funcionan es utilizando meta caracteres que ayudan a cuantificar, alterar o agrupar el texto, creando patrones de búsqueda. 

Entre estas dos paginas de recursos de funciones REGEX podemos hacer las siguientes comparaciones: 

En la primera página, <https://rstudio-pubs-static.s3.amazonaws.com/74603_76cd14d5983f47408fdf0b323550b846.html>, podemos ver detalladamente como podemos utilizar funciones Regex para manipular datos de tipo “string”. La página nos enseña  que tipos de paquetes usar como “stringr”, cuales funciones están relacionada a expresiones regulares y los diferentes tipos de sintaxis para buscar patrones dentro de un texto o lista de string. 
A su vez, el formato en el que esta estructurado la página es similar al de Rmarkdown, ya que divide los comentarios y las funciones o líneas de programación. Este formato nos ayuda a saber sin leer todo el texto, cuando se está viendo ejemplos con los códigos utilizados en R y cuando son comentarios. 
<br>  
La siguiente página, <https://stat.ethz.ch/R-manual/R-devel/library/base/html/regex.html>, está en un formato html y es difícil de entender ya que nos dice las funciones que pueden ser utilizadas para expresiones regulares, pero no nos da una explicación muy concreta de lo que significa. Todas las explicaciones están muy corridas, y no están bien segmentadas en relación con las características que se desean explicar. 
<br>

## Rmarkdown 

Rmarkdown se considera un marco de referencia en el que se puede usar codigo de R para crear reportes dinamicos y convertido en un formato leible ya sea por PDF, HTML o Word.

Entre las dos paginas de recursos de Rmarkdown podemos hacer las siguientes comparaciones: 

Esta página, <https://ourcodingclub.github.io/2016/11/24/rmarkdown-1.html>, nos enseña los principios básicos de Rmarkdown . Comenzando por como instalar un paquete, como estructurar el encabezado que se utiliza en R, como separar los códigos de los comentarios que se quieran proporcionar y esconderlos para que solo se vea el resultado.  Además, nos proporciona ejemplos al insertar figuras y tablas que son muy útiles al poner graficas. 

La siguiente página, <https://medium.com/@franperez/introduction-to-rmarkdown-fa0ad8338153>, nos explica sobre Rmarkdown de una forma muy generalizada, ya que no nos provee información de los procesos para añadirle un buen formato o como funciona el mismo Rmarkdown. Además, se salta mucho contenido sobre como se configuran los codigos y nos da el resultado final sin una explicación de los procedimientos utilizados para llegar al resultado. 


## Gráfica
```{r, echo=FALSE,include=FALSE,warning=FALSE}
#Webscrapping de tabla
url.index <- "https://www.indexmundi.com/commodities/?commodity=robusta-coffee&months=12&commodity=tea&indicator=price-ratio"
tmp <- read_html(url.index) #Extrae codigo de html
tmp
tmp <- html_nodes(tmp, "table") #Extrae los nodos de la tabla
sapply(tmp, function(x) dim(html_table(x, fill = TRUE)))
tmp <- html_table(tmp[[2]])

#Cambio de Nombres de columnas 
colnames(tmp) <- c("period","coffeeRobustaPrice$","teaPrecio$","coffee%change","tea%change","coffeeTeaRatio")
cafevste <- tmp
#Limpiar porcentaje de cambio 
dec1<- function(x){
  x<- gsub("\\%","",x)
}
dec2<- function(x){
  x<- gsub("-","0",x)
}
cafevste[4] <- lapply(cafevste[4],dec1)
cafevste[5] <- lapply(cafevste[5],dec1)
#Cambiar los signos negativos a numericos 
temp_value <- iconv(cafevste$`coffee%change`, "ISO_8859-2", "UTF-8")
test_output <- as.numeric(stringr::str_replace(temp_value, "â\u0088\u0092", "-"))
cafevste$`coffee%change` <- test_output
temp_value <- iconv(cafevste$`tea%change`, "ISO_8859-2", "UTF-8")
test_output <- as.numeric(stringr::str_replace(temp_value, "â\u0088\u0092", "-"))
cafevste$`tea%change`<- test_output

#Cambiar tablas a numerico
as.numeric(cafevste$`coffee%change`)
class(cafevste$`coffee%change`)
as.numeric(cafevste$`tea%change`)
class(cafevste$`tea%change`)
#Cambiar NA a 0
cafevste[is.na(cafevste)] <- 0

#Cambiar nombre de meses a numeros 
letras <- c("Nov", "Dec", "Jan","Feb", "Mar", "Apr", "May","Jun","Jul","Aug", "Sep", "Oct")
numeros <- c(11,12,01, 02, 03, 04, 05, 06, 07, 08, 09, 10)

dec3 <- function(p, r, x) {
  for(a in 1:length(p))
    x <- gsub(p[a], r[a], x)
  x
}

cafevste$period <- dec3(letras,numeros,cafevste$period)

#Formatear fechas 
dec4<- function(x){
  x<- gsub(" ","-",x)
}
cafevste[1] <- lapply(cafevste[1],dec4)



#Usar lubridate para cambiar el formato de periodo a fecha 

CvsT1 <- cafevste
CvsT1$period <- parse_date_time(CvsT1$period, "my")
CvsT1$period <- as.Date(CvsT1$period)
class(CvsT1$period)
#day(CvsT1$period) <- days_in_month(CvsT1$period)
CvsT1$period <- as.Date(CvsT1$period, format = "%Y-%m-%d")
cafevste <- CvsT1

#Cambio para hacer facetas 

head(CvsT1)
CvsT2 <- melt(CvsT1, id.vars = c("period", "coffeeRobustaPrice$", "teaPrecio$","coffeeTeaRatio"), variable.name = "Producto", value.name = "Cambio")


dec5<- function(x){
  x<- gsub("%(.*)","",x)
}
CvsT2[5] <- lapply(CvsT2[5],dec5)

dec6<- function(x){
  x<- gsub("coffee","café",x)
}
CvsT2[5] <- lapply(CvsT2[5],dec6)

dec7<- function(x){
  x<- gsub("tea","té",x)
}
CvsT2[5] <- lapply(CvsT2[5],dec7)

```
```{r web, echo=FALSE}

##Crea la grafica 
c <- ggplot(CvsT2, aes(x = period, y = Cambio, colour = Producto))+
  geom_line(size = 1) + geom_point(size = 2 ) +
  theme_minimal() +
  labs(title = "Variación de Precios\n Café Robusta vs Té", subtitle = "(Oct.2018 - Oct.2019)", 
       x = "Periodo" , y = "Cambio de Precio %", color = "Productos \n Basicos") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"), 
        plot.subtitle = element_text(hjust = 0.5, size = 10, face = "italic"))
c <- c + scale_x_date(breaks = "1 month", date_labels = "%b-%Y", limits = c(as.Date("2018-10-01"), as.Date("2019-10-31")))
c <- c + scale_color_manual(labels = c("Café", "Té"), values = c("Brown", "Orange"))
```
```{r plot, echo=FALSE, include=FALSE}
c <- ggplotly()
```
```{r grafica, echo=FALSE}
c
```

<br>
En este grafico podemos ver la comparación mensual entre la tasa de cambio en el precio del café robusta y la tasa de cambio en el precio del té. En primer lugar vemos que, dentro de los primeros meses, en Diciembre el precio del café tiende a ser el más bajo en todo el periodo de -7.07% y el té en este mes tiene cambios leves aproximadamente un -2.5%.  Podemos asumir que este mes se tiene un excedente de productividad de café en relación con su demanda, en lo que conlleva a que el mercado baje sus precios.  
<br><br>
Entrando Enero hasta Febrero, el comportamiento se tiende a invertir ya que para el precio del café tiende a estar más estable por 0.58% en los dos meses y él te baja por -3.55 puntos porcentuales. Luego entre Marzo hasta Agosto el precio del té tiende a variar dramáticamente. Por ejemplo, de Marzo a Abril el precio salta por +7.49 puntos y seguido de Mayo a Junio hay un cambio por -14.12 puntos. Con este cambio tan volátil podemos asumir que entre Marzo a Abril hubo menos producción en té y de Mayo a Junio hubo un excedente de lo presupuesto en el suministro del té.
<br><br>
En resumen, al comparar los dos productos básicos podemos destacar que el té tiende a ser más volátil ya que sus movimientos de precios son más drásticos entre cada mes al compararlos con sus puntos porcentuales. Por otra parte, el precio del café tiende a ser más predecibles mensualmente ya que en su mayoría el precio sube o baja entre dos periodos. Por ejemplo, de Abril a Agosto podemos ver un incremento de +1.62 y luego otro incremento más alto de +6.91 puntos porcentuales.



## Tabla de variación de precios
  
```{r tabla, echo = FALSE, include=FALSE}

CvsT3 <- CvsT1
select(CvsT3, -c(coffeeTeaRatio))
CvsT3 <- CvsT3[, c(1,2,4,3,5)]
Tabla <- kable(CvsT3, col.names = c("Periodo", "Precio Café", "Cambio % café","Precio Té", "Cambio % Té"), align = "l") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)

```


```{r table, echo = FALSE}
Tabla
```



